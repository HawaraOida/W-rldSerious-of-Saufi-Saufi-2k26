<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VuiBlattlympics 2k26</title>
    
    <!-- 1. Tailwind CSS f√ºr das Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. WICHTIG: Die UMD-Version der Supabase Bibliothek -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 pb-20">

    <!-- Header -->
    <div class="bg-emerald-700 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-3xl mx-auto flex items-start justify-between gap-2">
            <div class="flex items-start gap-3">
                <!-- Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-400 shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h18v18H3zM21 8H3M21 16H3M8 21V3M16 21V3" /> 
                </svg>
                
                <!-- Titel und neuer Text -->
                <div>
                    <h1 class="text-lg font-bold leading-tight">W√∂rld Serious of Saufi Saufi - VuiBlattlympics 2k26</h1>
                    <p class="text-[10px] text-emerald-100 leading-snug mt-1 max-w-md opacity-90">
                        Die Saufi Saufi Olympic G√§mz ‚Äì Saufolympics 2026 is des inoffizielle Gro√üereignis f√ºr olle, de liaba vui blattln statt trainiern. K√§mpft werd net nur um Elo, sondern um'n heiligen Wanderpokal zum ausa saufen.
                    </p>
                </div>
            </div>
            
            <!-- CSV Button (bleibt oben rechts) -->
            <button onclick="app.exportCSV()" class="text-xs bg-emerald-800 hover:bg-emerald-900 px-3 py-2 rounded border border-emerald-600 transition flex flex-col items-center gap-1 shrink-0">
                <span class="text-lg">üì•</span> 
                <span class="hidden sm:inline">Excel</span>
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="max-w-3xl mx-auto mt-4 px-2">
        <div class="flex bg-white rounded-lg shadow p-1 mb-6">
            <button onclick="app.setTab('rank')" id="btn-rank" class="flex-1 py-2 rounded text-sm font-medium transition bg-emerald-100 text-emerald-800">Rangliste</button>
            <button onclick="app.setTab('match')" id="btn-match" class="flex-1 py-2 rounded text-sm font-medium transition text-gray-500 hover:bg-gray-50">Match +</button>
            <button onclick="app.setTab('settings')" id="btn-settings" class="flex-1 py-2 rounded text-sm font-medium transition text-gray-500 hover:bg-gray-50">Spieler</button>
        </div>

        <!-- Content Container -->
        <div id="app-content" class="fade-in">
            <div class="text-center mt-10 text-slate-500 flex flex-col items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-700 mb-2"></div>
                <p>Verbinde mit Datenbank...</p>
            </div>
        </div>
    </div>

    <script>
        const K_FACTOR = 32;

        // **************************************************
        // 3. KONFIGURATION (HIER DEINE DATEN EINF√úGEN!)
        // **************************************************
        const SUPABASE_URL = 'https://tbeupewhdgcyxugxsfjd.supabase.co'; // <-- HIER ERSETZEN!
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiZXVwZXdoZGdjeXh1Z3hzZmpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NDY4NzIsImV4cCI6MjA3OTMyMjg3Mn0.hqICv1Yy4spdJa6sKZSnDXQL2r0sCHlBg3CL1DE10BU'; // <-- HIER ERSETZEN!
        
        // Client initialisieren
        let sbClient = null;

        try {
            if (typeof supabase === 'undefined') {
                throw new Error("Die Variable 'supabase' existiert nicht. Skript nicht geladen.");
            }
            sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase Client erfolgreich initialisiert.");
        } catch (e) {
            console.error("Supabase Init Fehler:", e);
            alert("Fehler: Supabase Bibliothek nicht geladen. Details in der Konsole (F12). Grund: " + e.message);
        }

        const app = {
            data: {
                players: [],
                history: [],
                activeTab: 'rank',
                matchInputs: Array(8).fill(''),
                winnerMode: 0 // 0 = Ranking, 1 = Winner Takes All
            },

            init() {
                if (!sbClient) return;
                
                this.fetchData()
                    .then(() => this.render())
                    .catch((err) => this.renderError(err));
            },

            // --- DATEN LADEN ---
            fetchData() {
                return new Promise(async (resolve, reject) => {
                    try {
                        let { data: players, error: playersError } = await sbClient
                            .from('players')
                            .select('id, name, elo, matches, wins')
                            .order('elo', { ascending: false });

                        if (playersError) throw playersError;

                        let { data: history, error: historyError } = await sbClient
                            .from('history')
                            .select('date, mode, ranking')
                            .order('date', { ascending: false });
                        
                        if (historyError) throw historyError;

                        this.data.players = players || [];
                        
                        this.data.history = (history || []).map(entry => ({
                            ...entry,
                            ranking: entry.ranking ? entry.ranking.split(',').map(s => s.trim()) : []
                        }));

                        if (this.data.players.length === 0) {
                            console.log("Datenbank leer, erstelle Standard-Spieler...");
                             this.data.players = Array.from({length: 8}, (_, i) => ({
                                id: 'p' + (i+1),
                                name: 'Saufi ' + (i+1),
                                elo: 1000,
                                matches: 0,
                                wins: 0
                            }));
                            await this.saveInitialPlayers(this.data.players);
                        }

                        resolve(true);

                    } catch (error) {
                        console.error("Ladefehler:", error);
                        reject(error);
                    }
                });
            },

            async saveInitialPlayers(players) {
                 const { error } = await sbClient.from('players').insert(players);
                 if (error) console.error("Init-Fehler:", error);
            },
            
            // --- DATEN SPEICHERN ---
            saveData(newHistoryEntry) {
                return new Promise(async (resolve, reject) => {
                    try {
                        const { error: deleteError } = await sbClient
                            .from('players')
                            .delete()
                            .neq('id', 'deleted');
                        
                        if (deleteError) throw deleteError;
                        
                        const { error: insertPlayersError } = await sbClient
                            .from('players')
                            .insert(this.data.players);
                            
                        if (insertPlayersError) throw insertPlayersError;

                        if (newHistoryEntry && newHistoryEntry.date) {
                            const { error: insertHistoryError } = await sbClient
                                .from('history')
                                .insert([{
                                    date: newHistoryEntry.date,
                                    mode: newHistoryEntry.mode,
                                    ranking: newHistoryEntry.ranking.join(', ')
                                }]);
                            if (insertHistoryError) throw insertHistoryError;
                        }

                        resolve(true);
                        
                    } catch (error) {
                        console.error("Speicherfehler:", error);
                        reject(error);
                    }
                });
            },

            resetData() {
                if(confirm("ACHTUNG: Dies l√∂scht ALLE Daten in der Datenbank f√ºr immer! Fortfahren?")) {
                    this.resetSupabaseData()
                        .then(() => location.reload())
                        .catch(err => alert("Fehler: " + err.message));
                }
            },
            
            async resetSupabaseData() {
                await sbClient.from('players').delete().neq('id', 'deleted');
                await sbClient.from('history').delete().neq('date', 'deleted');
            },

            // --- LOGIK & UI ---
            setTab(tab) {
                this.data.activeTab = tab;
                this.render();
            },

            setWinnerMode(mode) {
                this.data.winnerMode = mode;
                this.render();
            },

            updateMatchInput(index, value) {
                this.data.matchInputs[index] = value;
            },

            updatePlayerName(id, newName) {
                const p = this.data.players.find(pl => pl.id === id);
                if(p) {
                    p.name = newName;
                    this.saveData(null).catch(e => alert("Fehler beim Speichern des Namens"));
                }
            },

            getExpectation(ra, rb) {
                return 1 / (1 + Math.pow(10, (rb - ra) / 400));
            },

            submitMatch() {
                const inputs = [];
                for(let i=0; i<8; i++) {
                    const el = document.getElementById(`match-select-${i}`);
                    if(el) inputs.push(el.value);
                }

                const activeIds = inputs.filter(id => id !== "");

                if (activeIds.length < 2) return alert("Mindestens 2 Spieler n√∂tig!");
                if (new Set(activeIds).size !== activeIds.length) return alert("Spieler doppelt ausgew√§hlt!");

                const eloDeltas = {};
                activeIds.forEach(id => eloDeltas[id] = 0);
                const playersMap = new Map(this.data.players.map(p => [p.id, {...p}]));

                for (let i = 0; i < activeIds.length; i++) {
                    const pA = playersMap.get(activeIds[i]);
                    for (let j = i + 1; j < activeIds.length; j++) {
                        const pB = playersMap.get(activeIds[j]);
                        
                        const expA = this.getExpectation(pA.elo, pB.elo);
                        const expB = this.getExpectation(pB.elo, pA.elo);

                        let scoreA;
                        
                        if (this.data.winnerMode === 1) { 
                            if (i === 0) {
                                scoreA = 1;
                            } else {
                                continue;
                            }
                        } else {
                            scoreA = (i < j) ? 1 : 0; 
                        }
                        
                        if (scoreA !== undefined) {
                            eloDeltas[activeIds[i]] += K_FACTOR * (scoreA - expA);
                            eloDeltas[activeIds[j]] += K_FACTOR * ((1-scoreA) - expB);
                        }
                    }
                }

                this.data.players = this.data.players.map(p => {
                    if (eloDeltas[p.id] !== undefined) {
                        const isWinner = activeIds[0] === p.id;
                        return {
                            ...p,
                            elo: p.elo + eloDeltas[p.id],
                            matches: p.matches + 1,
                            wins: isWinner ? p.wins + 1 : p.wins
                        };
                    }
                    return p;
                });

                const newHistoryEntry = {
                    date: new Date().toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', hour: '2-digit', minute: '2-digit' }),
                    mode: this.data.winnerMode,
                    ranking: activeIds
                };

                const btn = document.getElementById('submit-btn');
                if(btn) btn.innerText = "Speichere...";
                
                this.saveData(newHistoryEntry)
                    .then(() => {
                        this.data.history.unshift(newHistoryEntry);
                        this.data.matchInputs = Array(8).fill('');
                        this.data.activeTab = 'rank';
                        this.render();
                    })
                    .catch((e) => {
                        alert("Fehler beim Speichern! Pr√ºfe Internet/RLS Policies.");
                        if(btn) btn.innerText = "Berechnen & Speichern";
                    });
            },

            exportCSV() {
                let csv = "RANG,NAME,ELO,SPIELE,SIEGE\n";
                [...this.data.players].sort((a,b) => b.elo - a.elo).forEach((p, i) => {
                    csv += `${i+1},${p.name},${Math.round(p.elo)},${p.matches},${p.wins}\n`;
                });
                
                csv += "\nMATCH HISTORY\nDATUM,MODUS,PLATZIERUNG...\n";
                this.data.history.forEach(m => {
                    const names = m.ranking.map(rid => this.data.players.find(p => p.id === rid)?.name).join(", ");
                    csv += `${m.date},${m.mode === 1 ? 'WinnerOnly' : 'Ranked'},"${names}"\n`;
                });

                const link = document.createElement("a");
                link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
                link.download = "SaufiSaufi_Elo_Export.csv";
                link.click();
            },

            render() {
                ['rank', 'match', 'settings'].forEach(t => {
                    const btn = document.getElementById(`btn-${t}`);
                    if(btn) {
                        if(this.data.activeTab === t) {
                            btn.className = "flex-1 py-2 rounded text-sm font-medium transition bg-emerald-100 text-emerald-800 shadow-sm";
                        } else {
                            btn.className = "flex-1 py-2 rounded text-sm font-medium transition text-gray-500 hover:bg-gray-50";
                        }
                    }
                });

                const container = document.getElementById('app-content');
                container.innerHTML = '';

                if (this.data.activeTab === 'rank') this.renderRank(container);
                else if (this.data.activeTab === 'match') this.renderMatch(container);
                else if (this.data.activeTab === 'settings') this.renderSettings(container);
            },
            
            renderError(err) {
                const container = document.getElementById('app-content');
                container.innerHTML = `
                    <div class="p-5 bg-red-50 border border-red-200 text-red-700 rounded-lg text-center">
                        <h2 class="font-bold mb-2">Verbindungsfehler</h2>
                        <p class="text-sm mb-4">Konnte Datenbank nicht erreichen.</p>
                        <div class="text-xs bg-white p-2 rounded border border-red-100 text-left overflow-auto max-h-32 font-mono mb-4">
                            ${err.message || JSON.stringify(err)}
                        </div>
                        <p class="text-xs">Pr√ºfe: URL, KEY und Supabase RLS Policies (SELECT=true).</p>
                        <button onclick="location.reload()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded text-sm">Neu laden</button>
                    </div>
                `;
            },

            renderRank(container) {
                const sorted = [...this.data.players].sort((a,b) => b.elo - a.elo);
                let html = `
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr><th class="p-3">#</th><th class="p-3">Name</th><th class="p-3 text-right">Elo</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">`;
                
                sorted.forEach((p, i) => {
                    let medal = '';
                    if(i===0) medal = 'ü•á';
                    if(i===1) medal = 'ü•à';
                    if(i===2) medal = 'ü•â';

                    html += `
                        <tr class="${i===0 ? 'bg-yellow-50' : ''}">
                            <td class="p-3 text-slate-400 text-sm font-mono">${i+1}</td>
                            <td class="p-3 font-medium">${p.name} ${medal}</td>
                            <td class="p-3 text-right font-bold text-emerald-600 font-mono">${Math.round(p.elo)}</td>
                        </tr>`;
                });
                html += `</tbody></table></div>`;

                html += `<h3 class="text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Letzte Matches</h3><div class="space-y-3">`;
                if(this.data.history.length === 0) html += `<p class="text-center text-sm text-slate-400 italic py-4">Keine Spiele bisher.</p>`;
                
                this.data.history.forEach(m => {
                    const namesHtml = m.ranking.map((rid, idx) => {
                        const name = this.data.players.find(p => p.id === rid)?.name || '?';
                        const style = idx === 0 ? 'bg-yellow-100 text-yellow-800 border-yellow-200 font-bold' : 'bg-white border-slate-200 text-slate-600';
                        return `<span class="px-2 py-1 rounded text-xs border ${style}">${idx+1}. ${name}</span>`;
                    }).join(' ');

                    html += `
                        <div class="bg-white p-3 rounded shadow-sm border-l-4 border-emerald-500">
                            <div class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase tracking-wide">
                                <span>${m.date}</span>
                                <span>${m.mode === 1 ? 'Winner Only' : 'Ranked'}</span>
                            </div>
                            <div class="flex flex-wrap gap-1">${namesHtml}</div>
                        </div>`;
                });
                html += `</div>`;
                container.innerHTML = html;
            },

            renderMatch(container) {
                const isRanked = this.data.winnerMode === 0;
                let html = `
                    <div class="bg-white rounded-lg shadow p-5">
                        <h2 class="font-bold mb-4">Neues Match eintragen</h2>
                        
                        <div class="flex gap-2 mb-6">
                            <button onclick="app.setWinnerMode(0)" class="flex-1 p-2 rounded border text-xs ${isRanked ? 'bg-emerald-600 text-white border-emerald-600 shadow-inner' : 'bg-slate-50 text-slate-600'}">
                                <strong>Platzierung</strong><br>Jeder Platz z√§hlt
                            </button>
                            <button onclick="app.setWinnerMode(1)" class="flex-1 p-2 rounded border text-xs ${!isRanked ? 'bg-emerald-600 text-white border-emerald-600 shadow-inner' : 'bg-slate-50 text-slate-600'}">
                                <strong>Winner Only</strong><br>Nur 1. Platz
                            </button>
                        </div>

                        <div class="space-y-3 mb-6">`;
                
                for(let i=0; i<8; i++) {
                    let options = `<option value="">-- Leer --</option>`;
                    this.data.players.forEach(p => {
                        const selected = this.data.matchInputs[i] === p.id ? 'selected' : '';
                        options += `<option value="${p.id}" ${selected}>${p.name} (${Math.round(p.elo)})</option>`;
                    });

                    html += `
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${i===0 ? 'bg-yellow-400 text-yellow-900' : 'bg-slate-200 text-slate-500'}">${i+1}</div>
                            <select id="match-select-${i}" onchange="app.updateMatchInput(${i}, this.value)" class="flex-1 p-2 border rounded bg-slate-50 text-sm outline-none focus:border-emerald-500">
                                ${options}
                            </select>
                        </div>`;
                }

                html += `</div>
                        <button id="submit-btn" onclick="app.submitMatch()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded transition shadow">Berechnen & Speichern</button>
                    </div>`;
                container.innerHTML = html;
            },

            renderSettings(container) {
                let html = `<div class="bg-white rounded-lg shadow p-5"><h2 class="font-bold mb-4">Spieler Namen</h2><div class="space-y-3 mb-6">`;
                
                this.data.players.forEach((p, i) => {
                    html += `
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400 w-4">${i+1}</span>
                            <input type="text" value="${p.name}" onchange="app.updatePlayerName('${p.id}', this.value)" class="flex-1 p-2 border rounded text-sm focus:border-emerald-500 outline-none">
                        </div>`;
                });

                html += `</div>
                        <div class="border-t pt-4 mt-4 text-center">
                            <button onclick="app.resetData()" class="text-red-500 text-xs hover:underline">‚ö†Ô∏è Datenbank zur√ºcksetzen</button>
                        </div>
                    </div>`;
                container.innerHTML = html;
            }
        };

        app.init();
    </script>
</body>
</html>

